name: Deploy

on:
  push:
    branches: [ 'main' ]

env:
  NAMESPACE: petrosa-apps

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set version
      id: version
      run: |
        BASE_VERSION=$(cat VERSION | tr -d '[:space:]')
        SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        VERSION="${BASE_VERSION}-r${{ github.run_number }}-${SHORT_SHA}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"

    - name: Create tag
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"
        git tag -a "$VERSION" -m "Release $VERSION"
        git push origin "$VERSION"

  build-and-push:
    name: Build & Push
    needs: create-release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Determine Version
      id: version
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Using version: ${VERSION}"
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - name: Extract Docker Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKERHUB_USERNAME }}/petrosa-data-manager
        tags: |
          type=raw,value=${{ steps.version.outputs.version }}
    - name: Build and Push Docker Image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ steps.version.outputs.version }}
          COMMIT_SHA=${{ github.sha }}
          BUILD_DATE=${{ steps.meta.outputs.date }}

  publish-to-pypi:
    name: Publish to PyPI
    needs: create-release
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Extract Version
      id: version
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        # Strip 'v' prefix for PyPI version
        PYPI_VERSION="${VERSION#v}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "pypi_version=${PYPI_VERSION}" >> $GITHUB_OUTPUT
        echo "Using PyPI version: ${PYPI_VERSION}"
    - name: Install Build Tools
      run: |
        python -m pip install --upgrade pip
        python -m pip install --upgrade build twine setuptools wheel
    - name: Build Package
      run: |
        PYPI_VERSION="${{ steps.version.outputs.pypi_version }}"
        echo "Building client package with version: $PYPI_VERSION"
        
        # Write version to VERSION file (read by setup.py)
        echo "$PYPI_VERSION" > VERSION
        
        # Build using setup.py directly (not pyproject.toml which is for the main service)
        python setup.py sdist bdist_wheel
        
        # Verify packages were created with correct naming
        echo "üì¶ Built packages:"
        ls -lh dist/
        
        # Verify the package name uses underscores (setup.py controls name via dynamic field)
        if ls dist/petrosa_data_manager_client-*.tar.gz 1> /dev/null 2>&1; then
          echo "‚úÖ Package built with correct naming (underscores)"
          echo "üì¶ Package: $(ls dist/petrosa_data_manager_client-*.tar.gz)"
        else
          echo "‚ùå ERROR: Package not found or has incorrect naming"
          echo "Expected: dist/petrosa_data_manager_client-*.tar.gz"
          echo "Found:"
          ls -la dist/ || echo "No dist/ directory"
          exit 1
        fi
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_TOKEN }}
        verbose: true

  gitops-update:
    name: GitOps Update
    needs: [build-and-push, create-release]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout petrosa_k8s
        uses: actions/checkout@v4
        with:
          repository: PetroSa2/petrosa_k8s
          ref: main
          token: ${{ secrets.GITOPS_BOT_TOKEN }}
          path: petrosa_k8s

      - name: Rebase on main
        run: ./scripts/gitops-rebase-main.sh
        working-directory: petrosa_k8s

      - name: Update data-manager image tag in GitOps manifests
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          # Update the image tag in manifests
          find petrosa_k8s/k8s/data-manager -name "*.yaml" -o -name "*.yml" | xargs sed -i "s/VERSION_PLACEHOLDER/$VERSION/g"
          
          # Also update the version label if needed
          find petrosa_k8s/k8s/data-manager -name "*.yaml" -o -name "*.yml" | xargs sed -i "s/version: VERSION_PLACEHOLDER/version: $VERSION/g"
          
          echo "Updated data-manager image tag to $VERSION in petrosa_k8s/k8s/data-manager/"

      - name: Commit and push to petrosa_k8s
        working-directory: petrosa_k8s
        run: |
          git config user.name "gitops-bot"
          git config user.email "gitops-bot@users.noreply.github.com"
          git add k8s/data-manager/
          if git diff --staged --quiet; then
            echo "No changes to commit (version might already be up to date)"
          else
            git commit -m "gitops: data-manager image ${{ needs.build-and-push.outputs.version }}"
            git push origin main
          fi

  notify:
    name: notify
    needs: [build-and-push, gitops-update, create-release]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Notify Deployment Status
      run: |
        VERSION="${{ needs.create-release.outputs.version }}"
        IMAGE_TAG="${{ needs.build-and-push.outputs.version }}"
        
        if [ "${{ needs.gitops-update.result }}" == "success" ]; then
          echo "‚úÖ Build, Push, and GitOps Update successful!"
          echo "üì¶ Version: ${VERSION}"
          echo "üöÄ Deployed via petrosa_k8s hub"
        elif [ "${{ needs.gitops-update.result }}" == "skipped" ] && [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "‚ÑπÔ∏è Pull Request: Build and Push successful (GitOps update skipped for PR)"
          echo "üì¶ Version: ${VERSION}"
        else
          echo "‚ùå GitOps Update failed (or was unsuccessful)!"
          echo "üì¶ Version: ${VERSION}"
          echo "üê≥ Image pushed, but manifest update in petrosa_k8s failed."
        fi

  cleanup:
    name: cleanup
    needs: [build-and-push]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Clean Up Old Images
      run: |
        echo "Cleaning up old Docker images..."
        echo "Docker Hub cleanup would happen here"

